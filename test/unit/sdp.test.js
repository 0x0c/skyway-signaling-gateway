const sdp = require('../../libs/miscs/sdp.js')

const offers = {
  'js_datachannel': [
    "v=0",
    "o=- 1709970026514555613 2 IN IP4 127.0.0.1",
    "s=-",
    "t=0 0",
    "a=msid-semantic: WMS",
    "m=application 9 DTLS/SCTP 5000",
    "c=IN IP4 0.0.0.0",
    "a=ice-ufrag:iZEB",
    "a=ice-pwd:Xn2veALWANzcg9ZGZHaiVROS",
    "a=fingerprint:sha-256 A6:65:A8:67:2C:EE:B5:34:3B:75:BD:B0:38:58:32:10:9D:49:7D:AD:23:BB:D3:FE:E0:23:81:88:FC:39:4C:AB",
    "a=setup:actpass",
    "a=mid:data",
    "a=sctpmap:5000 webrtc-datachannel 1024"
  ],
  'js_audio': [
    "v=0",
    "o=- 5667805489341495591 2 IN IP4 127.0.0.1",
    "s=-",
    "t=0 0",
    "a=group:BUNDLE audio",
    "a=msid-semantic: WMS b4pNr2wG0WsmkhOWkBKqyrOXW1h6gCsvAAZR",
    "m=audio 9 UDP/TLS/RTP/SAVPF 111 103 104 9 0 8 106 105 13 126",
    "c=IN IP4 0.0.0.0",
    "a=rtcp:9 IN IP4 0.0.0.0",
    "a=ice-ufrag:RXgm",
    "a=ice-pwd:NZTVvItyl/81+6fhpsW6iyHP",
    "a=fingerprint:sha-256 7F:45:F1:0F:06:36:24:67:B2:8F:0E:4D:A4:38:E6:EB:68:4B:1B:BB:B4:77:31:42:11:D9:4A:F2:EF:8C:03:37",
    "a=setup:actpass",
    "a=mid:audio",
    "a=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level",
    "a=extmap:3 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",
    "a=sendrecv",
    "a=rtcp-mux",
    "a=rtpmap:111 opus/48000/2",
    "a=rtcp-fb:111 transport-cc",
    "a=fmtp:111 minptime=10;useinbandfec=1",
    "a=rtpmap:103 ISAC/16000",
    "a=rtpmap:104 ISAC/32000",
    "a=rtpmap:9 G722/8000",
    "a=rtpmap:0 PCMU/8000",
    "a=rtpmap:8 PCMA/8000",
    "a=rtpmap:106 CN/32000",
    "a=rtpmap:105 CN/16000",
    "a=rtpmap:13 CN/8000",
    "a=rtpmap:126 telephone-event/8000",
    "a=ssrc:2423570347 cname:drvI1f+kfw+EEvaX",
    "a=ssrc:2423570347 msid:b4pNr2wG0WsmkhOWkBKqyrOXW1h6gCsvAAZR 62284951-6da4-4cef-8c67-c01faf64d076",
    "a=ssrc:2423570347 mslabel:b4pNr2wG0WsmkhOWkBKqyrOXW1h6gCsvAAZR",
    "a=ssrc:2423570347 label:62284951-6da4-4cef-8c67-c01faf64d076"
  ],
  'js_video': [
    'v=0',
    'o=- 6893979118231637080 2 IN IP4 127.0.0.1',
    's=-',
    't=0 0',
    'a=group:BUNDLE video',
    'a=msid-semantic: WMS QRxrm8oV7QHcm3FP86OtddGsSAem2QOuq3I9',
    'm=video 9 UDP/TLS/RTP/SAVPF 100 101 107 116 117 96 97 99 98',
    'c=IN IP4 0.0.0.0',
    'a=rtcp:9 IN IP4 0.0.0.0',
    'a=ice-ufrag:J/Q6',
    'a=ice-pwd:opa80bvke7RgXiaY1Zfclnao',
    'a=fingerprint:sha-256 8F:5D:67:BD:50:22:37:D8:9B:A1:F1:9C:9A:F9:D4:C0:B5:0A:54:12:51:B5:6F:9D:81:23:06:FC:FD:FD:CA:8B',
    'a=setup:actpass',
    'a=mid:video',
    'a=extmap:2 urn:ietf:params:rtp-hdrext:toffset',
    'a=extmap:3 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time',
    'a=extmap:4 urn:3gpp:video-orientation',
    'a=extmap:6 http://www.webrtc.org/experiments/rtp-hdrext/playout-delay',
    'a=sendrecv',
    'a=rtcp-mux',
    'a=rtcp-rsize',
    'a=rtpmap:100 VP8/90000',
    'a=rtcp-fb:100 ccm fir',
    'a=rtcp-fb:100 nack',
    'a=rtcp-fb:100 nack pli',
    'a=rtcp-fb:100 goog-remb',
    'a=rtcp-fb:100 transport-cc',
    'a=rtpmap:101 VP9/90000',
    'a=rtcp-fb:101 ccm fir',
    'a=rtcp-fb:101 nack',
    'a=rtcp-fb:101 nack pli',
    'a=rtcp-fb:101 goog-remb',
    'a=rtcp-fb:101 transport-cc',
    'a=rtpmap:107 H264/90000',
    'a=rtcp-fb:107 ccm fir',
    'a=rtcp-fb:107 nack',
    'a=rtcp-fb:107 nack pli',
    'a=rtcp-fb:107 goog-remb',
    'a=rtcp-fb:107 transport-cc',
    'a=fmtp:107 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f',
    'a=rtpmap:116 red/90000',
    'a=rtpmap:117 ulpfec/90000',
    'a=rtpmap:96 rtx/90000',
    'a=fmtp:96 apt=100',
    'a=rtpmap:97 rtx/90000',
    'a=fmtp:97 apt=101',
    'a=rtpmap:99 rtx/90000',
    'a=fmtp:99 apt=107',
    'a=rtpmap:98 rtx/90000',
    'a=fmtp:98 apt=116',
    'a=ssrc-group:FID 1389714712 2782147336',
    'a=ssrc:1389714712 cname:B8Fxo36TjRFYwyoF',
    'a=ssrc:1389714712 msid:QRxrm8oV7QHcm3FP86OtddGsSAem2QOuq3I9 cb6f7afd-f8a9-4a04-af5b-353dbe50e234',
    'a=ssrc:1389714712 mslabel:QRxrm8oV7QHcm3FP86OtddGsSAem2QOuq3I9',
    'a=ssrc:1389714712 label:cb6f7afd-f8a9-4a04-af5b-353dbe50e234',
    'a=ssrc:2782147336 cname:B8Fxo36TjRFYwyoF',
    'a=ssrc:2782147336 msid:QRxrm8oV7QHcm3FP86OtddGsSAem2QOuq3I9 cb6f7afd-f8a9-4a04-af5b-353dbe50e234',
    'a=ssrc:2782147336 mslabel:QRxrm8oV7QHcm3FP86OtddGsSAem2QOuq3I9',
    'a=ssrc:2782147336 label:cb6f7afd-f8a9-4a04-af5b-353dbe50e234'
  ],
  'js_media': [
    'v=0',
    'o=- 5780276008605885862 2 IN IP4 127.0.0.1',
    's=-',
    't=0 0',
    'a=group:BUNDLE audio video',
    'a=msid-semantic: WMS Qklc6CogOvUeEHJXm81C8bmhscN9YbqBflxP',
    'm=audio 9 UDP/TLS/RTP/SAVPF 111 103 104 9 0 8 106 105 13 126',
    'c=IN IP4 0.0.0.0',
    'a=rtcp:9 IN IP4 0.0.0.0',
    'a=ice-ufrag:ZHoB',
    'a=ice-pwd:D/yrwOANpIUbB1h/jiGo9bxc',
    'a=fingerprint:sha-256 92:4E:C1:7D:00:70:75:0F:D6:C2:2B:23:DD:33:6B:02:D3:A5:B4:8A:FC:E5:A9:DD:B9:16:0A:15:D0:E6:9F:A3',
    'a=setup:actpass',
    'a=mid:audio',
    'a=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level',
    'a=extmap:3 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time',
    'a=sendrecv',
    'a=rtcp-mux',
    'a=rtpmap:111 opus/48000/2',
    'a=rtcp-fb:111 transport-cc',
    'a=fmtp:111 minptime=10;useinbandfec=1',
    'a=rtpmap:103 ISAC/16000',
    'a=rtpmap:104 ISAC/32000',
    'a=rtpmap:9 G722/8000',
    'a=rtpmap:0 PCMU/8000',
    'a=rtpmap:8 PCMA/8000',
    'a=rtpmap:106 CN/32000',
    'a=rtpmap:105 CN/16000',
    'a=rtpmap:13 CN/8000',
    'a=rtpmap:126 telephone-event/8000',
    'a=ssrc:3849236340 cname:ttpDYV3Ba/NdQIz6',
    'a=ssrc:3849236340 msid:Qklc6CogOvUeEHJXm81C8bmhscN9YbqBflxP b8f501fb-45e5-4483-8ef4-b956fb5891c6',
    'a=ssrc:3849236340 mslabel:Qklc6CogOvUeEHJXm81C8bmhscN9YbqBflxP',
    'a=ssrc:3849236340 label:b8f501fb-45e5-4483-8ef4-b956fb5891c6',
    'm=video 9 UDP/TLS/RTP/SAVPF 100 101 107 116 117 96 97 99 98',
    'c=IN IP4 0.0.0.0',
    'a=rtcp:9 IN IP4 0.0.0.0',
    'a=ice-ufrag:ZHoB',
    'a=ice-pwd:D/yrwOANpIUbB1h/jiGo9bxc',
    'a=fingerprint:sha-256 92:4E:C1:7D:00:70:75:0F:D6:C2:2B:23:DD:33:6B:02:D3:A5:B4:8A:FC:E5:A9:DD:B9:16:0A:15:D0:E6:9F:A3',
    'a=setup:actpass',
    'a=mid:video',
    'a=extmap:2 urn:ietf:params:rtp-hdrext:toffset',
    'a=extmap:3 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time',
    'a=extmap:4 urn:3gpp:video-orientation',
    'a=extmap:6 http://www.webrtc.org/experiments/rtp-hdrext/playout-delay',
    'a=sendrecv',
    'a=rtcp-mux',
    'a=rtcp-rsize',
    'a=rtpmap:100 VP8/90000',
    'a=rtcp-fb:100 ccm fir',
    'a=rtcp-fb:100 nack',
    'a=rtcp-fb:100 nack pli',
    'a=rtcp-fb:100 goog-remb',
    'a=rtcp-fb:100 transport-cc',
    'a=rtpmap:101 VP9/90000',
    'a=rtcp-fb:101 ccm fir',
    'a=rtcp-fb:101 nack',
    'a=rtcp-fb:101 nack pli',
    'a=rtcp-fb:101 goog-remb',
    'a=rtcp-fb:101 transport-cc',
    'a=rtpmap:107 H264/90000',
    'a=rtcp-fb:107 ccm fir',
    'a=rtcp-fb:107 nack',
    'a=rtcp-fb:107 nack pli',
    'a=rtcp-fb:107 goog-remb',
    'a=rtcp-fb:107 transport-cc',
    'a=fmtp:107 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f',
    'a=rtpmap:116 red/90000',
    'a=rtpmap:117 ulpfec/90000',
    'a=rtpmap:96 rtx/90000',
    'a=fmtp:96 apt=100',
    'a=rtpmap:97 rtx/90000',
    'a=fmtp:97 apt=101',
    'a=rtpmap:99 rtx/90000',
    'a=fmtp:99 apt=107',
    'a=rtpmap:98 rtx/90000',
    'a=fmtp:98 apt=116',
    'a=ssrc-group:FID 2492945537 3821431106',
    'a=ssrc:2492945537 cname:ttpDYV3Ba/NdQIz6',
    'a=ssrc:2492945537 msid:Qklc6CogOvUeEHJXm81C8bmhscN9YbqBflxP 18730bc7-a89b-43f4-9672-54b33f19f40b',
    'a=ssrc:2492945537 mslabel:Qklc6CogOvUeEHJXm81C8bmhscN9YbqBflxP',
    'a=ssrc:2492945537 label:18730bc7-a89b-43f4-9672-54b33f19f40b',
    'a=ssrc:3821431106 cname:ttpDYV3Ba/NdQIz6',
    'a=ssrc:3821431106 msid:Qklc6CogOvUeEHJXm81C8bmhscN9YbqBflxP 18730bc7-a89b-43f4-9672-54b33f19f40b',
    'a=ssrc:3821431106 mslabel:Qklc6CogOvUeEHJXm81C8bmhscN9YbqBflxP',
    'a=ssrc:3821431106 label:18730bc7-a89b-43f4-9672-54b33f19f40b'
  ]
}

const expects = {
  'js_datachannel': offers.js_datachannel.join("\r\n"),
  'js_audio': [
    "v=0",
    "o=- 5667805489341495591 2 IN IP4 127.0.0.1",
    "s=-",
    "t=0 0",
    "a=group:BUNDLE audio",
    "a=msid-semantic: WMS b4pNr2wG0WsmkhOWkBKqyrOXW1h6gCsvAAZR",
    "m=audio 9 UDP/TLS/RTP/SAVPF 111",
    "c=IN IP4 0.0.0.0",
    "a=rtcp:9 IN IP4 0.0.0.0",
    "a=ice-ufrag:RXgm",
    "a=ice-pwd:NZTVvItyl/81+6fhpsW6iyHP",
    "a=fingerprint:sha-256 7F:45:F1:0F:06:36:24:67:B2:8F:0E:4D:A4:38:E6:EB:68:4B:1B:BB:B4:77:31:42:11:D9:4A:F2:EF:8C:03:37",
    "a=setup:actpass",
    "a=mid:audio",
    "a=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level",
    "a=extmap:3 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",
    "a=sendrecv",
    "a=rtcp-mux",
    "a=rtpmap:111 opus/48000/2",
    "a=rtcp-fb:111 transport-cc",
    "a=fmtp:111 minptime=10;useinbandfec=1",
    "a=ssrc:2423570347 cname:drvI1f+kfw+EEvaX",
    "a=ssrc:2423570347 msid:b4pNr2wG0WsmkhOWkBKqyrOXW1h6gCsvAAZR 62284951-6da4-4cef-8c67-c01faf64d076",
    "a=ssrc:2423570347 mslabel:b4pNr2wG0WsmkhOWkBKqyrOXW1h6gCsvAAZR",
    "a=ssrc:2423570347 label:62284951-6da4-4cef-8c67-c01faf64d076"
  ].join("\r\n"),
  'js_video': offers.js_video.join("\r\n"),
  'js_media': [
    'v=0',
    'o=- 5780276008605885862 2 IN IP4 127.0.0.1',
    's=-',
    't=0 0',
    'a=group:BUNDLE audio video',
    'a=msid-semantic: WMS Qklc6CogOvUeEHJXm81C8bmhscN9YbqBflxP',
    'm=audio 9 UDP/TLS/RTP/SAVPF 111',
    'c=IN IP4 0.0.0.0',
    'a=rtcp:9 IN IP4 0.0.0.0',
    'a=ice-ufrag:ZHoB',
    'a=ice-pwd:D/yrwOANpIUbB1h/jiGo9bxc',
    'a=fingerprint:sha-256 92:4E:C1:7D:00:70:75:0F:D6:C2:2B:23:DD:33:6B:02:D3:A5:B4:8A:FC:E5:A9:DD:B9:16:0A:15:D0:E6:9F:A3',
    'a=setup:actpass',
    'a=mid:audio',
    'a=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level',
    'a=extmap:3 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time',
    'a=sendrecv',
    'a=rtcp-mux',
    'a=rtpmap:111 opus/48000/2',
    'a=rtcp-fb:111 transport-cc',
    'a=fmtp:111 minptime=10;useinbandfec=1',
    'a=ssrc:3849236340 cname:ttpDYV3Ba/NdQIz6',
    'a=ssrc:3849236340 msid:Qklc6CogOvUeEHJXm81C8bmhscN9YbqBflxP b8f501fb-45e5-4483-8ef4-b956fb5891c6',
    'a=ssrc:3849236340 mslabel:Qklc6CogOvUeEHJXm81C8bmhscN9YbqBflxP',
    'a=ssrc:3849236340 label:b8f501fb-45e5-4483-8ef4-b956fb5891c6',
    'm=video 9 UDP/TLS/RTP/SAVPF 100 101 107 116 117 96 97 99 98',
    'c=IN IP4 0.0.0.0',
    'a=rtcp:9 IN IP4 0.0.0.0',
    'a=ice-ufrag:ZHoB',
    'a=ice-pwd:D/yrwOANpIUbB1h/jiGo9bxc',
    'a=fingerprint:sha-256 92:4E:C1:7D:00:70:75:0F:D6:C2:2B:23:DD:33:6B:02:D3:A5:B4:8A:FC:E5:A9:DD:B9:16:0A:15:D0:E6:9F:A3',
    'a=setup:actpass',
    'a=mid:video',
    'a=extmap:2 urn:ietf:params:rtp-hdrext:toffset',
    'a=extmap:3 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time',
    'a=extmap:4 urn:3gpp:video-orientation',
    'a=extmap:6 http://www.webrtc.org/experiments/rtp-hdrext/playout-delay',
    'a=sendrecv',
    'a=rtcp-mux',
    'a=rtcp-rsize',
    'a=rtpmap:100 VP8/90000',
    'a=rtcp-fb:100 ccm fir',
    'a=rtcp-fb:100 nack',
    'a=rtcp-fb:100 nack pli',
    'a=rtcp-fb:100 goog-remb',
    'a=rtcp-fb:100 transport-cc',
    'a=rtpmap:101 VP9/90000',
    'a=rtcp-fb:101 ccm fir',
    'a=rtcp-fb:101 nack',
    'a=rtcp-fb:101 nack pli',
    'a=rtcp-fb:101 goog-remb',
    'a=rtcp-fb:101 transport-cc',
    'a=rtpmap:107 H264/90000',
    'a=rtcp-fb:107 ccm fir',
    'a=rtcp-fb:107 nack',
    'a=rtcp-fb:107 nack pli',
    'a=rtcp-fb:107 goog-remb',
    'a=rtcp-fb:107 transport-cc',
    'a=fmtp:107 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f',
    'a=rtpmap:116 red/90000',
    'a=rtpmap:117 ulpfec/90000',
    'a=rtpmap:96 rtx/90000',
    'a=fmtp:96 apt=100',
    'a=rtpmap:97 rtx/90000',
    'a=fmtp:97 apt=101',
    'a=rtpmap:99 rtx/90000',
    'a=fmtp:99 apt=107',
    'a=rtpmap:98 rtx/90000',
    'a=fmtp:98 apt=116',
    'a=ssrc-group:FID 2492945537 3821431106',
    'a=ssrc:2492945537 cname:ttpDYV3Ba/NdQIz6',
    'a=ssrc:2492945537 msid:Qklc6CogOvUeEHJXm81C8bmhscN9YbqBflxP 18730bc7-a89b-43f4-9672-54b33f19f40b',
    'a=ssrc:2492945537 mslabel:Qklc6CogOvUeEHJXm81C8bmhscN9YbqBflxP',
    'a=ssrc:2492945537 label:18730bc7-a89b-43f4-9672-54b33f19f40b',
    'a=ssrc:3821431106 cname:ttpDYV3Ba/NdQIz6',
    'a=ssrc:3821431106 msid:Qklc6CogOvUeEHJXm81C8bmhscN9YbqBflxP 18730bc7-a89b-43f4-9672-54b33f19f40b',
    'a=ssrc:3821431106 mslabel:Qklc6CogOvUeEHJXm81C8bmhscN9YbqBflxP',
    'a=ssrc:3821431106 label:18730bc7-a89b-43f4-9672-54b33f19f40b'
  ].join("\r\n")
}

describe('force_opus', () => {
  // test for js_datachannel
  it('should not change sdp of js_datachannel with \\r\\n', () => {
    expect( sdp.force_opus(offers.js_datachannel.join("\r\n")) ).toBe( expects.js_datachannel )
  })
  it('should change line feed code of datachannel sdp from \\r to \\r\\n', () => {
    expect( sdp.force_opus(offers.js_datachannel.join("\r")) ).toBe( expects.js_datachannel )
  })
  it('should change line feed code of datachannel sdp from \\n to \\r\\n', () => {
    expect( sdp.force_opus(offers.js_datachannel.join("\n")) ).toBe( expects.js_datachannel )
  })

  // test for js_audio
  it('should change sdp of js_audio with \\r\\n', () => {
    expect( sdp.force_opus(offers.js_audio.join("\r\n")) ).toBe( expects.js_audio )
  })
  it('should change sdp of js_audio and line feed code from \\r to \\r\\n', () => {
    expect( sdp.force_opus(offers.js_audio.join("\r")) ).toBe( expects.js_audio )
  })
  it('should change sdp of js_audio and line feed code from \\n to \\r\\n', () => {
    expect( sdp.force_opus(offers.js_audio.join("\n")) ).toBe( expects.js_audio )
  })

  // test for js_video
  it('should not change sdp of js_video with \\r\\n', () => {
    expect( sdp.force_opus(offers.js_video.join("\r\n")) ).toBe( expects.js_video )
  })
  it('should change line feed code of video sdp from \\r to \\r\\n', () => {
    expect( sdp.force_opus(offers.js_video.join("\r")) ).toBe( expects.js_video )
  })
  it('should change line feed code of video sdp from \\n to \\r\\n', () => {
    expect( sdp.force_opus(offers.js_video.join("\n")) ).toBe( expects.js_video )
  })

  // test for js_media(both audio and video)
  it('should change sdp of js_media with \\r\\n', () => {
    expect( sdp.force_opus(offers.js_media.join("\r\n")) ).toBe( expects.js_media )
  })

  it('should change sdp of js_media and line feed code from \\r to \\r\\n', () => {
    expect( sdp.force_opus(offers.js_media.join("\r")) ).toBe( expects.js_media )
  })

  it('should change sdp of js_media and line feed code from \\n to \\r\\n', () => {
    expect( sdp.force_opus(offers.js_media.join("\n")) ).toBe( expects.js_media )
  })
})
